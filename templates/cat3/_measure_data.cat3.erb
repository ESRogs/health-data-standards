
<!--   MEASURE DATA REPORTING FOR    <%= population.type %>  <%= population.id %>  -->
<observation classCode="OBS" moodCode="EVN">
  <!-- Measure Data template -->
  <templateId root="2.16.840.1.113883.10.20.27.3.5"/>
  <!-- CMS EP Measure Data template (CONF:711266) -->
  <templateId root="2.16.840.1.113883.10.20.27.3.16"/>
  <code code="ASSERTION" 
        codeSystem="2.16.840.1.113883.5.4" 
        displayName="Assertion" 
        codeSystemName="ActCode"/>
  <statusCode code="completed"/>
  <value xsi:type="CD" code="<%= population.type %>" 
         codeSystem="2.16.840.1.113883.5.1063"  
         codeSystemName="ObservationValue"/>
  <!-- Aggregate Count -->
  <entryRelationship typeCode="SUBJ" inversionInd="true">
    <observation classCode="OBS" moodCode="EVN">
      <templateId root="2.16.840.1.113883.10.20.27.3.3"/>
      <!-- Aggregate Count (CMS EP) template ID (CONF:711263) -->
      <templateId root="2.16.840.1.113883.10.20.27.3.24"/>
      <code code="MSRAGG" 
        displayName="rate aggregation" 
        codeSystem="2.16.840.1.113883.5.4" 
        codeSystemName="ActCode"/>
      <!-- (CONF:711245) -->
      <statusCode code="completed"/>
      <value xsi:type="INT" value="<%= population.value.round %>"/>
      <methodCode code="COUNT" 
        displayName="Count" 
        codeSystem="2.16.840.1.113883.5.84" 
        codeSystemName="ObservationMethod"/>
    </observation>
  </entryRelationship>
  <% population.stratifications.each do |strat| -%>

  <!--  Startification Reporting Template for <%= population.type %>  <%= population.id %>  Stratification <%= strat.id %>   -->

  <entryRelationship typeCode="COMP">
    <observation classCode="OBS" moodCode="EVN">
      <templateId root="2.16.840.1.113883.10.20.27.3.4"/>
      <!-- Reporting Stratum (CMS EP) template ID (CONF:711275) -->
      <templateId root="2.16.840.1.113883.10.20.27.3.20"/>
      <code code="ASSERTION" 
            codeSystem="2.16.840.1.113883.5.4" 
            displayName="Assertion" 
            codeSystemName="ActCode"/>
      <statusCode code="completed"/>
      <!-- TODO: (CONF:711232) requires us to know the code element in the measure, but this isn't stored.
                value is a SHOULD though. Might always be 2112-8 birth date?
      <value xsi:type="CD" nullFlavor="OTH">
       <originalText>Stratum</originalText>
      </value>
      -->
      <entryRelationship typeCode="SUBJ" inversionInd="true">
        <observation classCode="OBS" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.27.3.3"/>
          <!-- Aggregate Count (CMS EP) template ID CONF:711263. -->
          <templateId root="2.16.840.1.113883.10.20.27.3.24"/>
          <code code="MSRAGG" 
                displayName="rate aggregation" 
                codeSystem="2.16.840.1.113883.5.4" 
                codeSystemName="ActCode"/>
          <!-- (CONF:711245) -->
          <statusCode code="completed"/>
          <value xsi:type="INT" value="<%= strat.value.round %>"/>
          <methodCode code="COUNT" 
                      displayName="Count" 
                      codeSystem="2.16.840.1.113883.5.84" 
                      codeSystemName="ObservationMethod"/>
        </observation>
      </entryRelationship>
      <% if population.type == 'MSRPOPL' -%>
      <% 
      #need to lookup the observation population entry and then find the stratification entry for it
      observ = aggregate_count.populations.find{|p| p.type == "OBSERV"}
      obs_strat = observ.stratifications.find{|s| s.id == strat.id}
        if obs_strat
      %>
      <%== render :partial => 'continuous_variable_value', :locals => {:id => observ.id, :value=>obs_strat.value } %>
      <% 
        end
      end -%>
      <reference typeCode="REFR">
        <externalObservation classCode="OBS" moodCode="EVN">
          <id root="<%= strat.id %>"/>
        </externalObservation>
      </reference>
    </observation>
  </entryRelationship>
  <% end -%>
  <% if population.supplemental_data.present? -%>
  <%   sex_supplimental_data = population.supplemental_data["SEX"]
       supplemental_info[:sex].each do |concept|
         sex = concept
         count = sex_supplimental_data[sex] || 0 -%>
   
   <!--    SEX Supplemental Data Reporting for <%= population.type %>  <%= population.id %>      --> 
         
  <%== render :partial => 'supplemental_data', :locals => {:template_name => 'Sex Supplemental Data', 
                :template_id => '2.16.840.1.113883.10.20.27.3.6',  :cms_template_id => '2.16.840.1.113883.10.20.27.3.21',
                :supplemental_data_code => '184100006',
                :supplemental_data_code_system => '2.16.840.1.113883.6.96', :supplemental_data_value_code => sex,
                :supplemental_data_value_code_system => '2.16.840.1.113762.1.4.1', :count => count} %>
      <% end -%>
  <%   ethnicity_supplimental_data = population.supplemental_data["ETHNICITY"]
       supplemental_info[:ethnicity].each do |concept|
         ethnicity = concept
         count = sex_supplimental_data[ethnicity] || 0 -%>

    <!--     ETHNICITY Supplemental Data Reporting  for <%= population.type %>  <%= population.id %>     --> 

  <%== render :partial => 'supplemental_data', :locals => {:template_name => 'Ethnicity Supplemental Data', 
                :template_id => '2.16.840.1.113883.10.20.27.3.7', :cms_template_id => '2.16.840.1.113883.10.20.27.3.22',
                :supplemental_data_code => '364699009',
                :supplemental_data_code_system => '2.16.840.1.113883.6.96', :supplemental_data_value_code => ethnicity,
                :supplemental_data_value_code_system => '2.16.840.1.113883.6.238', :count => count} %>   
      <% end -%>
  <%   race_supplimental_data = population.supplemental_data["RACE"]
        supplemental_info[:race].each do |concept|
            race = concept
            count = race_supplimental_data[race] || 0
  -%>

   <!--      RACE Supplemental Data Reporting  for <%= population.type %>  <%= population.id %> --> 

  <%== render :partial => 'supplemental_data', :locals => {:template_name => 'Race Supplemental Data', 
                :template_id => '2.16.840.1.113883.10.20.27.3.8', :cms_template_id => '2.16.840.1.113883.10.20.27.3.19',
                :supplemental_data_code => '103579009',
                :supplemental_data_code_system => '2.16.840.1.113883.6.96', :supplemental_data_value_code => race,
                :supplemental_data_value_code_system => '2.16.840.1.113883.6.238', :count => count} %>   
      <% end -%>
  <%   payer_supplimental_data = population.supplemental_data["CMS_PAYER"]
       supplemental_info[:payer].each do |concept|
         payer = concept
         count = payer_supplimental_data[payer] || 0 -%>

 <!--         PAYER Supplemental Data Reporting   for<%= population.type %>  <%= population.id %>   -->

  <%== render :partial => 'supplemental_data', :locals => {:template_name => 'Payer Supplemental Data', 
                :template_id => '2.16.840.1.113883.10.20.27.3.9', :cms_template_id => '2.16.840.1.113883.10.20.27.3.18',
                :supplemental_data_code => '48768-6',
                :supplemental_data_code_system => '2.16.840.1.113883.6.1', :supplemental_data_value_code => payer,
                :supplemental_data_value_code_system => '2.16.840.1.113883.3.221.5', :count => count} %>
    <% end -%>
  <% end -%>
  <% if population.type == 'MSRPOPL' -%>
  <%  observ = aggregate_count.populations.find{|p| p.type == "OBSERV"} %>
  <%== render :partial => 'continuous_variable_value', :locals => {:id => observ.id, :value=>observ.value}%>
  <% end -%>
  <reference typeCode="REFR">
     <externalObservation classCode="OBS" moodCode="EVN">
        <id root="<%= population.id %>"/>
     </externalObservation>
  </reference>
</observation>